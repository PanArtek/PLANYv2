---
import Button from '../ui/Button.astro';
import Icon from '../ui/Icon.astro';
import { PROJECT_TYPES, BUDGET_RANGES, TIMELINES } from '../../utils/constants';
---

<section class="contact py-20 bg-white" id="kontakt">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
      <!-- Section Header -->
      <div class="contact-header text-center mb-16">
        <h2 class="text-4xl lg:text-5xl font-bold text-slate-800 mb-6">
          Poproś o <span class="text-blue-600">Wycenę</span>
        </h2>
        <p class="text-xl text-slate-600 max-w-3xl mx-auto leading-relaxed">
          Skontaktuj się z nami, aby otrzymać bezpłatną wycenę dopasowaną do Twojego projektu. 
          Odpowiemy w ciągu 24 godzin.
        </p>
      </div>

      <div class="grid lg:grid-cols-2 gap-12 items-start">
        <!-- Contact Form -->
        <div class="contact-form">
          <div class="bg-slate-50 rounded-2xl p-8">
            <h3 class="text-2xl font-semibold text-slate-800 mb-6">Formularz wyceny</h3>
            
            <form 
              name="quote-request" 
              method="POST" 
              data-netlify="true" 
              netlify-honeypot="bot-field"
              class="space-y-6"
              id="quoteForm"
            >
              <!-- Honeypot field -->
              <input type="hidden" name="bot-field" />
              <input type="hidden" name="form-name" value="quote-request" />

              <!-- Project Type -->
              <div class="form-group">
                <label for="projectType" class="block text-sm font-medium text-slate-700 mb-2">
                  Typ projektu *
                </label>
                <select 
                  id="projectType" 
                  name="projectType" 
                  required
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                >
                  <option value="">Wybierz typ projektu</option>
                  {PROJECT_TYPES.map(type => (
                    <option value={type.value}>{type.label}</option>
                  ))}
                </select>
              </div>

              <!-- Location and Area -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-group">
                  <label for="location" class="block text-sm font-medium text-slate-700 mb-2">
                    Lokalizacja *
                  </label>
                  <input 
                    type="text" 
                    id="location" 
                    name="location" 
                    required
                    placeholder="np. Warszawa, Mokotów"
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                  />
                </div>
                <div class="form-group">
                  <label for="area" class="block text-sm font-medium text-slate-700 mb-2">
                    Powierzchnia (m²) *
                  </label>
                  <input 
                    type="number" 
                    id="area" 
                    name="area" 
                    required
                    min="1"
                    placeholder="np. 200"
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                  />
                </div>
              </div>

              <!-- Budget and Timeline -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-group">
                  <label for="budget" class="block text-sm font-medium text-slate-700 mb-2">
                    Budżet orientacyjny
                  </label>
                  <select 
                    id="budget" 
                    name="budget"
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                  >
                    <option value="">Wybierz zakres budżetu</option>
                    {BUDGET_RANGES.map(budget => (
                      <option value={budget.value}>{budget.label}</option>
                    ))}
                  </select>
                </div>
                <div class="form-group">
                  <label for="timeline" class="block text-sm font-medium text-slate-700 mb-2">
                    Preferowany termin
                  </label>
                  <select 
                    id="timeline" 
                    name="timeline"
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                  >
                    <option value="">Wybierz termin realizacji</option>
                    {TIMELINES.map(timeline => (
                      <option value={timeline.value}>{timeline.label}</option>
                    ))}
                  </select>
                </div>
              </div>

              <!-- Project Description -->
              <div class="form-group">
                <label for="description" class="block text-sm font-medium text-slate-700 mb-2">
                  Opis projektu *
                </label>
                <textarea 
                  id="description" 
                  name="description" 
                  required
                  rows="4"
                  placeholder="Opisz swój projekt, wymagania specjalne, oczekiwania..."
                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-vertical"
                ></textarea>
              </div>

              <!-- Contact Information -->
              <div class="space-y-4">
                <h4 class="text-lg font-medium text-slate-800">Dane kontaktowe</h4>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div class="form-group">
                    <label for="name" class="block text-sm font-medium text-slate-700 mb-2">
                      Imię i nazwisko *
                    </label>
                    <input 
                      type="text" 
                      id="name" 
                      name="name" 
                      required
                      placeholder="Jan Kowalski"
                      class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                    />
                  </div>
                  <div class="form-group">
                    <label for="company" class="block text-sm font-medium text-slate-700 mb-2">
                      Firma
                    </label>
                    <input 
                      type="text" 
                      id="company" 
                      name="company"
                      placeholder="Nazwa firmy"
                      class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                    />
                  </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div class="form-group">
                    <label for="email" class="block text-sm font-medium text-slate-700 mb-2">
                      Email *
                    </label>
                    <input 
                      type="email" 
                      id="email" 
                      name="email" 
                      required
                      placeholder="jan@example.com"
                      class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                    />
                  </div>
                  <div class="form-group">
                    <label for="phone" class="block text-sm font-medium text-slate-700 mb-2">
                      Telefon *
                    </label>
                    <input 
                      type="tel" 
                      id="phone" 
                      name="phone" 
                      required
                      placeholder="+48 123 456 789"
                      class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                    />
                  </div>
                </div>
              </div>

              <!-- Consent and Submit -->
              <div class="space-y-4">
                <div class="flex items-start gap-3">
                  <input 
                    type="checkbox" 
                    id="consent" 
                    name="consent" 
                    required
                    class="mt-1 w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500"
                  />
                  <label for="consent" class="text-sm text-slate-600">
                    Wyrażam zgodę na przetwarzanie moich danych osobowych w celu przygotowania wyceny. *
                  </label>
                </div>
                
                <div class="flex items-start gap-3">
                  <input 
                    type="checkbox" 
                    id="marketing" 
                    name="marketing"
                    class="mt-1 w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500"
                  />
                  <label for="marketing" class="text-sm text-slate-600">
                    Wyrażam zgodę na otrzymywanie informacji marketingowych.
                  </label>
                </div>

                <Button 
                  type="submit" 
                  variant="primary" 
                  size="lg" 
                  class="w-full submit-btn"
                  id="submitBtn"
                >
                  <span class="submit-text">Wyślij zapytanie</span>
                  <span class="loading-text hidden">Wysyłanie...</span>
                </Button>
              </div>
            </form>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="contact-info space-y-8">
          <!-- Direct Contact -->
          <div class="bg-blue-50 rounded-2xl p-8">
            <h3 class="text-2xl font-semibold text-slate-800 mb-6">Skontaktuj się bezpośrednio</h3>
            
            <div class="space-y-6">
              <div class="contact-item flex items-start gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                  <Icon name="Phone" class="w-6 h-6 text-white" />
                </div>
                <div>
                  <h4 class="text-lg font-medium text-slate-800 mb-1">Telefon</h4>
                  <a href="tel:+48123456789" class="text-blue-600 hover:text-blue-700 transition-colors">
                    +48 123 456 789
                  </a>
                  <p class="text-sm text-slate-600 mt-1">Pon-Pt: 8:00-18:00</p>
                </div>
              </div>

              <div class="contact-item flex items-start gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                  <Icon name="Mail" class="w-6 h-6 text-white" />
                </div>
                <div>
                  <h4 class="text-lg font-medium text-slate-800 mb-1">Email</h4>
                  <a href="mailto:kontakt@fitoutpro.pl" class="text-blue-600 hover:text-blue-700 transition-colors">
                    kontakt@fitoutpro.pl
                  </a>
                  <p class="text-sm text-slate-600 mt-1">Odpowiadamy w 24h</p>
                </div>
              </div>

              <div class="contact-item flex items-start gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                  <Icon name="MapPin" class="w-6 h-6 text-white" />
                </div>
                <div>
                  <h4 class="text-lg font-medium text-slate-800 mb-1">Adres</h4>
                  <p class="text-slate-700">ul. Główna 123</p>
                  <p class="text-slate-700">00-001 Warszawa</p>
                  <p class="text-sm text-slate-600 mt-1">Działamy w całej Polsce</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Process Steps -->
          <div class="bg-slate-50 rounded-2xl p-8">
            <h3 class="text-2xl font-semibold text-slate-800 mb-6">Jak przebiega współpraca?</h3>
            
            <div class="space-y-6">
              <div class="process-step flex items-start gap-4">
                <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold flex-shrink-0">
                  1
                </div>
                <div>
                  <h4 class="font-medium text-slate-800 mb-1">Konsultacja i wycena</h4>
                  <p class="text-sm text-slate-600">Omawiamy projekt i przygotowujemy bezpłatną wycenę w 24h</p>
                </div>
              </div>

              <div class="process-step flex items-start gap-4">
                <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold flex-shrink-0">
                  2
                </div>
                <div>
                  <h4 class="font-medium text-slate-800 mb-1">Projekt i wizualizacja</h4>
                  <p class="text-sm text-slate-600">Tworzymy projekt 3D dopasowany do Twoich potrzeb</p>
                </div>
              </div>

              <div class="process-step flex items-start gap-4">
                <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold flex-shrink-0">
                  3
                </div>
                <div>
                  <h4 class="font-medium text-slate-800 mb-1">Realizacja</h4>
                  <p class="text-sm text-slate-600">Własny zespół wykonuje prace zgodnie z harmonogramem</p>
                </div>
              </div>

              <div class="process-step flex items-start gap-4">
                <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold flex-shrink-0">
                  4
                </div>
                <div>
                  <h4 class="font-medium text-slate-800 mb-1">Odbiór i gwarancja</h4>
                  <p class="text-sm text-slate-600">Odbiór projektu i 24-miesięczna gwarancja</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Trust Indicators -->
          <div class="trust-indicators grid grid-cols-2 gap-4">
            <div class="trust-item text-center p-4 bg-white border border-slate-200 rounded-lg">
              <div class="text-2xl font-bold text-blue-600 mb-1">24h</div>
              <div class="text-sm text-slate-600">Czas odpowiedzi</div>
            </div>
            <div class="trust-item text-center p-4 bg-white border border-slate-200 rounded-lg">
              <div class="text-2xl font-bold text-blue-600 mb-1">24m</div>
              <div class="text-sm text-slate-600">Gwarancja</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-xl max-w-md w-full p-6 text-center">
    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <Icon name="Check" class="w-8 h-8 text-green-600" />
    </div>
    <h3 class="text-xl font-semibold text-slate-800 mb-2">Zapytanie wysłane!</h3>
    <p class="text-slate-600 mb-6">Dziękujemy za zapytanie. Skontaktujemy się z Tobą w ciągu 24 godzin.</p>
    <Button id="closeSuccessModal" variant="primary" class="w-full">
      Zamknij
    </Button>
  </div>
</div>

<style>
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-group input.error,
  .form-group select.error,
  .form-group textarea.error {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
  }

  .contact-item {
    animation: slideInUp 0.6s ease-out both;
  }

  .contact-item:nth-child(1) { animation-delay: 0.1s; }
  .contact-item:nth-child(2) { animation-delay: 0.2s; }
  .contact-item:nth-child(3) { animation-delay: 0.3s; }

  .process-step {
    animation: slideInUp 0.6s ease-out both;
  }

  .process-step:nth-child(1) { animation-delay: 0.1s; }
  .process-step:nth-child(2) { animation-delay: 0.2s; }
  .process-step:nth-child(3) { animation-delay: 0.3s; }
  .process-step:nth-child(4) { animation-delay: 0.4s; }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Reduced motion fallback */
  @media (prefers-reduced-motion: reduce) {
    .contact-item,
    .process-step {
      animation: none !important;
    }
  }
</style>

<script type="module">
  function initContactAnimations() {
    if (!window.gsap || !window.ScrollTrigger) return;
    
    gsap.registerPlugin(ScrollTrigger);
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    if (prefersReducedMotion) {
      return;
    }

    // Animate contact header
    gsap.fromTo('.contact-header', 
      { opacity: 0, y: 30 },
      {
        opacity: 1,
        y: 0,
        duration: 0.8,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: '.contact-header',
          start: 'top 80%'
        }
      }
    );

    // Animate form and contact info
    gsap.fromTo('.contact-form, .contact-info > div', 
      { opacity: 0, y: 30 },
      {
        opacity: 1,
        y: 0,
        duration: 0.8,
        ease: 'power2.out',
        stagger: 0.2,
        scrollTrigger: {
          trigger: '.contact-form',
          start: 'top 70%'
        }
      }
    );
  }

  function initFormValidation() {
    const form = document.getElementById('quoteForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = submitBtn?.querySelector('.submit-text');
    const loadingText = submitBtn?.querySelector('.loading-text');

    if (!form) return;

    // Real-time validation
    const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
    
    inputs.forEach(input => {
      input.addEventListener('blur', () => validateField(input));
      input.addEventListener('input', () => {
        if (input.classList.contains('error')) {
          validateField(input);
        }
      });
    });

    function validateField(field) {
      const isValid = field.checkValidity();
      
      if (isValid) {
        field.classList.remove('error');
        removeErrorMessage(field);
      } else {
        field.classList.add('error');
        showErrorMessage(field);
      }
      
      return isValid;
    }

    function showErrorMessage(field) {
      removeErrorMessage(field);
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message text-red-600 text-sm mt-1';
      
      if (field.validity.valueMissing) {
        errorDiv.textContent = 'To pole jest wymagane';
      } else if (field.validity.typeMismatch) {
        if (field.type === 'email') {
          errorDiv.textContent = 'Wprowadź prawidłowy adres email';
        } else if (field.type === 'tel') {
          errorDiv.textContent = 'Wprowadź prawidłowy numer telefonu';
        }
      } else {
        errorDiv.textContent = 'Wprowadź prawidłową wartość';
      }
      
      field.parentNode.appendChild(errorDiv);
    }

    function removeErrorMessage(field) {
      const errorMsg = field.parentNode.querySelector('.error-message');
      if (errorMsg) {
        errorMsg.remove();
      }
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Validate all fields
      let isFormValid = true;
      inputs.forEach(input => {
        if (!validateField(input)) {
          isFormValid = false;
        }
      });

      if (!isFormValid) {
        return;
      }

      // Show loading state
      if (submitBtn && submitText && loadingText) {
        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        loadingText.classList.remove('hidden');
      }

      try {
        // Submit to Netlify
        const formData = new FormData(form);
        
        const response = await fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(formData).toString()
        });

        if (response.ok) {
          showSuccessModal();
          form.reset();
        } else {
          throw new Error('Form submission failed');
        }
      } catch (error) {
        console.error('Form submission error:', error);
        alert('Wystąpił błąd podczas wysyłania formularza. Spróbuj ponownie lub skontaktuj się z nami telefonicznie.');
      } finally {
        // Reset button state
        if (submitBtn && submitText && loadingText) {
          submitBtn.disabled = false;
          submitText.classList.remove('hidden');
          loadingText.classList.add('hidden');
        }
      }
    });
  }

  function showSuccessModal() {
    const modal = document.getElementById('successModal');
    const closeBtn = document.getElementById('closeSuccessModal');
    
    if (!modal) return;

    modal.classList.remove('hidden');
    modal.classList.add('flex');

    const closeModal = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    closeBtn?.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
  }

  // Initialize when DOM is ready
  function init() {
    initContactAnimations();
    initFormValidation();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>